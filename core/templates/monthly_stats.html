{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
  <h2>Monthly Stats</h2>
  <hr>
  <table class="table">
    <thead>
      <tr>
        <th>Month</th>
        <th>Year</th>
        <th>Profit</th>
        <th>Percentage</th>
      </tr>
    </thead>
    <tbody>
      <!-- Monthly data will be dynamically added here -->
    </tbody>
  </table>
</div>

<div class="container mt-5">
  <h2>Yearly Stats</h2>
  <hr>
  <table class="table">
    <thead>
      <tr>
        <th>Year</th>
        <th>Profit</th>
        <th>Percentage</th>
      </tr>
    </thead>
    <tbody>
      <!-- Yearly data will be dynamically added here -->
    </tbody>
  </table>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    let contextData = JSON.parse('{{ context_json|safe }}');
    let profitList = contextData.profit_list;
    let openingTimeList = contextData.opening_time_list;

    let monthlyData = [];
    let yearlyData = {};
    let totalProfit = 0;
    
    // Calculate monthly and yearly profits
    for (let i = 0; i < openingTimeList.length; i++) {
      let dateComponents = openingTimeList[i].split('-');
      let month = dateComponents[1];
      let year = dateComponents[0];
      let profit = profitList[i];
      
      let monthYear = month + '-' + year;
      
      // Update monthly data
      if (monthYear in monthlyData) {
        monthlyData[monthYear] += profit;
      } else {
        monthlyData[monthYear] = profit;
      }
      
      // Update yearly data
      if (year in yearlyData) {
        yearlyData[year] += profit;
      } else {
        yearlyData[year] = profit;
      }
      
      totalProfit += profit;
    }
    
    // Create monthly data array
    let monthlyTableBody = document.querySelector('tbody');
    for (let monthYear in monthlyData) {
      let [month, year] = monthYear.split('-');
      let profit = monthlyData[monthYear];
      let percentage = ((profit / totalProfit) * 100).toFixed(2);
      
      let row = document.createElement('tr');
      
      let monthCell = document.createElement('td');
      monthCell.textContent = month;
      
      let yearCell = document.createElement('td');
      yearCell.textContent = year;
      
      let profitCell = document.createElement('td');
      profitCell.textContent = profit;
      
      let percentageCell = document.createElement('td');
      percentageCell.textContent = percentage + '%';
      
      row.appendChild(monthCell);
      row.appendChild(yearCell);
      row.appendChild(profitCell);
      row.appendChild(percentageCell);
      
      monthlyTableBody.appendChild(row);
    }
    
    // Create yearly data array
    let yearlyTableBody = document.querySelectorAll('tbody')[1];
    for (let year in yearlyData) {
      let profit = yearlyData[year];
      let percentage = ((profit / totalProfit) * 100).toFixed(2);
      
      let row = document.createElement('tr');
      
      let yearCell = document.createElement('td');
      yearCell.textContent = year;
      
      let profitCell = document.createElement('td');
      profitCell.textContent = profit;
      
      let percentageCell = document.createElement('td');
      percentageCell.textContent = percentage + '%';
      
      row.appendChild(yearCell);
      row.appendChild(profitCell);
      row.appendChild(percentageCell);
      
      yearlyTableBody.appendChild(row);
    }
  });
</script>
{% endblock %}
