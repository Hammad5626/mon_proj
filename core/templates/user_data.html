{% extends 'base.html' %}
{% load static %}

{% block content %}
  <div class="container">
    <!----------------------------- Code for Balance Growth Chart ------------------------------------->
      <h2>{{ user.name }} Data</h2>
      <hr>
      <div class="graph-container">
          <h3>Balance Growth</h3>
          <div id="chartDiv1" style="width: 100%; height: calc(100vh - 100px);"></div>
      </div>
      <hr>
    <!----------------------------- End of Code for Balance Growth ------------------------------------>

    <!----------------------------- Code for Percentage Growth Chart ---------------------------------->
      <div class="graph-container">
          <h3>Percentage Balance</h3>
          <div id="chartDiv2" style="width: 100%; height: calc(100vh - 100px);"></div>
      </div>
      <hr>
    <!----------------------------- End of Code for Percentage Growth --------------------------------->

    <!----------------------------- Code for Monthly / Yearly Stats ----------------------------------->
      <div class="monthly-stats-container">
          <div class="container mt-5">
              <h2>Monthly Stats</h2>
              <hr>
              <table class="table">
                  <thead>
                      <tr>
                          <th>Month</th>
                          <th>Percentage</th>
                      </tr>
                  </thead>
                  <tbody>
                      <!-- Monthly data will be dynamically added here -->
                  </tbody>
              </table>
          </div>
          <div class="container mt-5">
              <h2>Yearly Stats</h2>
              <hr>
                <table class="table">
                  <thead>
                    <tr>
                      <th>Year</th>
                      <th>Percentage</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Yearly data will be dynamically added here -->
                  </tbody>
                </table>
            </div>
        </div>
    <!-------------------------- End of Code for Monthly / Yearly Stats ------------------------------->
  </div>
  <script>
    var contextJson = JSON.parse('{{ context_json|safe }}');
  </script>
  <script type="text/javascript" src="{% static 'js/user_data/balance_growth.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/user_data/percentage_growth.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let contextData = contextJson;
      let profitList = contextData.profit_list;
      let netProfitList = contextData.net_profit_list;
      let typeList = contextData.type_list;
      let openingTimeList = contextData.time_list;
      let totalBalance = [profitList[0]];
      let monthlyData = {};
      let yearlyData = {};
      let currentBalance = 0;
    
      for (let i = 0; i < profitList.length; i++) {
        if (i !== 0 && typeList[i] !== "Balance") {
          currentBalance = totalBalance[i - 1] + netProfitList[i];
          totalBalance.push(currentBalance);
        }
        else if(i !== 0 && typeList[i] === "Balance") {
          currentBalance = totalBalance[i - 1] + profitList[i];
          totalBalance.push(currentBalance);
        }
      }
      let year =0;
      for (let i = 0; i < openingTimeList.length; i++) {
        let dateComponents = openingTimeList[i].split('-');
        let month = dateComponents[1];
        year = dateComponents[0];
        let currentBalance = totalBalance[i];
        let monthYear = month + '-' + year;
        
        
        if (monthYear in monthlyData) {
          if (i < openingTimeList.length - 2 && month === openingTimeList[i+1].split('-')[1] && typeList[i+1] === "Balance"){
            let result = ((currentBalance - monthlyData[monthYear].initialValue) / monthlyData[monthYear].initialValue) *100;
            result = (result / 100) +1;
            monthlyData[monthYear].iterator *= result;
          }
          else if (typeList[i] === "Balance"){
            monthlyData[monthYear].initialValue = currentBalance;
          }
          monthlyData[monthYear].finalValue = currentBalance;
        } else {
          monthlyData[monthYear] = {
            initialValue: currentBalance,
            finalValue: 0,
            iterator: 1
          };
        }
      }
    
      let yearlyPercentage = 1;
      // Calculate the percentage growth for each month
      let monthlyTableBody = document.querySelector('tbody');
      let monthYearArray = Object.keys(monthlyData);
      for (let i = 0; i < monthYearArray.length; i++) {
        let monthYear = monthYearArray[i];
        let [month, year] = monthYear.split('-');
        let initialValue = monthlyData[monthYear].initialValue;
        let finalValue = monthlyData[monthYear].finalValue;
        let iterator = monthlyData[monthYear].iterator;
        let percentageOfMonth = 0;
        let result = 0;
    
        if (initialValue !== 0) {
          result = ((finalValue - initialValue) / initialValue) * 100;
          result = (result / 100) +1;
          iterator *= result;
          percentageOfMonth = (iterator - 1) * 100;
          yearlyPercentage *= (percentageOfMonth/100) +1;
        }
    
        let row = document.createElement('tr');
        let yearMonthCell = document.createElement('td');
        let percentageOfMonthCell = document.createElement('td');
    
        yearMonthCell.textContent = year + '-' + month;
        percentageOfMonthCell.textContent = percentageOfMonth.toFixed(2) + '%';
    
        row.appendChild(yearMonthCell);
        row.appendChild(percentageOfMonthCell);
    
        monthlyTableBody.appendChild(row);
      }
    
      // Create yearly data array
      let yearlyTableBody = document.querySelectorAll('tbody')[1];
        yearlyPercentage = (yearlyPercentage - 1)*100;
        let row = document.createElement('tr');
    
        let yearCell = document.createElement('td');
        yearCell.textContent = year;
    
        let percentageCell = document.createElement('td');
        percentageCell.textContent = yearlyPercentage.toFixed(2) + '%';
    
        row.appendChild(yearCell);
        row.appendChild(percentageCell);
    
        yearlyTableBody.appendChild(row);
    });
  </script>
{% endblock %}

<!-------------------------- End of File ------------------------------->